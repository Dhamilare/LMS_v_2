{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}HR Appraisal Dashboard{% endblock %}

{% block content %}
<div class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl shadow-indigo-100 max-w-7xl mx-auto my-6 sm:my-8 border border-gray-100">
    
    {# --- HEADER --- #}
    <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
        <i class="fas fa-chart-bar mr-3 text-indigo-600"></i> HR L&D Performance Dashboard
    </h2>
    <p class="text-gray-600 text-lg mb-8 border-b pb-4">Track, filter, and analyze employee learning completion data for performance appraisal reviews.</p>

    {# ========================================================================= #}
    {# 1. KPI Summary Cards #}
    {# ========================================================================= #}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        
        {# Card 1: Total Enrollments #}
        <div class="bg-indigo-600 p-5 rounded-xl shadow-lg border-b-4 border-indigo-800 text-white transform hover:scale-[1.02] transition duration-300">
            <p class="text-sm opacity-80 uppercase tracking-wider">Total Enrollments</p>
            <h3 class="text-3xl font-bold mt-2 flex items-center">
                <i class="fas fa-users mr-3 opacity-70"></i> {{ stats.total }}
            </h3>
        </div>

        {# Card 2: Completed Enrollments #}
        <div class="bg-green-600 p-5 rounded-xl shadow-lg border-b-4 border-green-800 text-white transform hover:scale-[1.02] transition duration-300">
            <p class="text-sm opacity-80 uppercase tracking-wider">Completed Courses</p>
            <h3 class="text-3xl font-bold mt-2 flex items-center">
                <i class="fas fa-check-double mr-3 opacity-70"></i> {{ stats.completed }}
            </h3>
        </div>

        {# Card 3: In Progress #}
        <div class="bg-yellow-500 p-5 rounded-xl shadow-lg border-b-4 border-yellow-700 text-white transform hover:scale-[1.02] transition duration-300">
            <p class="text-sm opacity-80 uppercase tracking-wider">In Progress</p>
            <h3 class="text-3xl font-bold mt-2 flex items-center">
                <i class="fas fa-hourglass-half mr-3 opacity-70"></i> {{ stats.in_progress }}
            </h3>
        </div>

        {# Card 4: Average Completion Rate #}
        <div class="bg-blue-600 p-5 rounded-xl shadow-lg border-b-4 border-blue-800 text-white transform hover:scale-[1.02] transition duration-300">
            <p class="text-sm opacity-80 uppercase tracking-wider">Avg. Completion Rate</p>
            <h3 class="text-3xl font-bold mt-2 flex items-center">
                <i class="fas fa-percentage mr-3 opacity-70"></i> {{ stats.average_completion }}%
            </h3>
        </div>
    </div>
    
    {# ========================================================================= #}
    {# 2. Chart Breakdown & Advanced Filter (Two-Column Layout) #}
    {# ========================================================================= #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
        
        {# Chart Column (2/3 width on large screens) #}
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-pie mr-2 text-indigo-500"></i> Completion Rate by Department
            </h3>
            <div class="w-full h-96 flex items-center justify-center">
                <canvas id="dept-completion-chart"></canvas>
            </div>
            {{ chart_data|json_script:"hr_chart_data" }}
        </div>

        {# Advanced Filter Column (1/3 width on large screens) #}
        <div class="lg:col-span-1">
            <form method="GET" action="{% url 'hr_appraisal_dashboard' %}" class="bg-gray-100 p-6 rounded-xl shadow-inner space-y-5 border border-gray-200 sticky top-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-funnel-dollar mr-2 text-indigo-600"></i> Data Filters</h3>

                {# Search Query #}
                <div>
                    <label for="id_q" class="block text-sm font-medium text-gray-700">Student/Course Search</label>
                    <input type="search" name="q" id="id_q" value="{{ search_query }}"
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Name, Email, or Course Title">
                </div>

                {# Status Filter #}
                <div>
                    <label for="id_status" class="block text-sm font-medium text-gray-700">Completion Status</label>
                    <select name="status" id="id_status" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">All Statuses</option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                    </select>
                </div>

                {# Department Filter #}
                <div>
                    <label for="id_department" class="block text-sm font-medium text-gray-700">Student's Department</label>
                    <select name="department" id="id_department" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">All Departments</option>
                        {% for dept in department_choices %}
                            <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                {# Instructor Filter #}
                <div>
                    <label for="id_instructor" class="block text-sm font-medium text-gray-700">Course Instructor</label>
                    <select name="instructor" id="id_instructor" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">All Instructors</option>
                        {% for instructor in instructor_choices %}
                            <option value="{{ instructor.pk }}" {% if instructor_filter|slugify == instructor.pk|slugify %}selected{% endif %}>{{ instructor.get_full_name|default:instructor.email }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="flex flex-col space-y-3 pt-3">
                    <button type="submit" class="bg-indigo-600 text-white py-2.5 px-4 rounded-full hover:bg-indigo-700 transition duration-200 font-semibold shadow-md flex items-center justify-center">
                        <i class="fas fa-filter mr-2"></i> Apply Filters
                    </button>
                    <a href="?export=csv&{{ request.GET.urlencode }}" class="bg-green-600 text-white py-2.5 px-4 rounded-full hover:bg-green-700 transition duration-200 font-semibold shadow-md flex items-center justify-center">
                        <i class="fas fa-file-excel mr-2"></i> Export Data (CSV)
                    </a>
                    <a href="{% url 'hr_appraisal_dashboard' %}" class="bg-gray-300 text-gray-800 py-2.5 px-4 rounded-full hover:bg-gray-400 transition duration-200 font-medium flex items-center justify-center">
                        <i class="fas fa-redo mr-2"></i> Clear Filters
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    {# ========================================================================= #}
    {# 3. Results Table #}
    {# ========================================================================= #}
    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-table mr-2 text-indigo-500"></i> Detailed Enrollment Records
    </h3>
    
    <div class="overflow-x-auto rounded-xl shadow-xl border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Student Name</th>
                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Course Title</th>
                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Instructor</th>
                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Dept.</th>
                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Progress</th>
                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Enrolled On</th>
                    <th scope="col" class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Completed On</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for enrollment in page_obj %}
                <tr class="hover:bg-indigo-50 transition duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ enrollment.student.get_full_name|default:enrollment.student.email }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                        {{ enrollment.course.title }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ enrollment.course.instructor.get_full_name|default:enrollment.course.instructor.email }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ enrollment.student.department|default:"N/A" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full transition-all duration-300 
                                {% if enrollment.completed %}bg-green-600{% else %}bg-indigo-600{% endif %}" 
                                style="width: {{ enrollment.progress_perc }}%;">
                            </div>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 block font-semibold">{{ enrollment.progress_perc|floatformat:0 }}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full 
                            {% if enrollment.completed %}bg-green-100 text-green-800{% else %}bg-indigo-100 text-indigo-800{% endif %}">
                            {% if enrollment.completed %}Completed{% else %}In Progress{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">
                        {{ enrollment.enrolled_at|date:"M d, Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">
                        {% if enrollment.completed_at %}
                            {{ enrollment.completed_at|date:"M d, Y" }}
                        {% else %}
                            â€”
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-xl text-gray-500 bg-gray-50">
                        <i class="fas fa-search-minus mb-2 block text-2xl"></i>
                        No enrollment data found matching your current filters.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.has_other_pages %}
        <div class="mt-8 flex justify-center">
            {% include 'includes/pagination.html' with page_obj=page_obj page_param='page' %}
        </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
    const chartDataElement = document.getElementById('hr_chart_data');
    
    if (chartDataElement) {
        const chartData = chartDataElement.textContent;
        const data = JSON.parse(chartData);
    
        const labels = data.labels;
        const percentages = data.percentages;

        // Fix 2: Determine background colors dynamically based on percentage success threshold
        // Using Tailwind color palette
        const colors = percentages.map(p => {
            if(p < 50) return 'rgba(239, 68, 68, 0.9)'; // Red-500
            else if(p < 80) return 'rgba(251, 191, 36, 0.9)'; // Yellow-500
            else return 'rgba(16, 185, 129, 0.9)'; // Green-500
        });

        const borderColors = percentages.map(p => {
            if(p < 50) return 'rgb(239, 68, 68)';
            else if(p < 80) return 'rgb(251, 191, 36)';
            else return 'rgb(16, 185, 129)';
        });
    
        const ctx = document.getElementById('dept-completion-chart').getContext('2d');
    
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: percentages,
                    backgroundColor: colors, 
                    borderColor: borderColors,
                    borderWidth: 1,
                    borderRadius: 4, // Added rounded bars for modern look
                }]
            },
            options: {
                indexAxis: 'y', // Horizontal bars
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            drawOnChartArea: false // Cleaner look
                        },
                        title: {
                            display: true,
                            text: 'Completion Rate (%)',
                            font: { weight: 'bold' }
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)' // Light horizontal lines
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleFont: { weight: 'bold' },
                        bodyFont: { weight: 'bold' },
                        callbacks: {
                            label: function(context) {
                                return ` ${context.raw.toFixed(1)}% Completed`;
                            }
                        }
                    }
                }
            }
        });
    } else {
        console.warn("Chart data element 'hr_chart_data' not found. Chart display skipped.");
    }
</script>
{% endblock %}