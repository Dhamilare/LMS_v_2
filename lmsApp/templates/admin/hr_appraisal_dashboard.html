{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}HR Appraisal Dashboard{% endblock %}

{% block content %}
<div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-7xl mx-auto my-6 sm:my-8">
    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-chart-line mr-2 sm:mr-3 text-indigo-600"></i> HR Appraisal & Completion Tracker
    </h2>

    <p class="text-gray-600 text-base sm:text-lg mb-6">Filter student enrollment and course completion data for appraisal review.</p>

    {# ========================================================================= #}
    {# 1. KPI Summary Cards #}
    {# ========================================================================= #}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-indigo-50 p-4 rounded-xl shadow-md border border-indigo-200">
            <p class="text-sm text-indigo-600">Total Enrollments</p>
            <h3 class="text-2xl font-bold text-indigo-900 mt-1">{{ stats.total }}</h3>
        </div>

        <div class="bg-green-50 p-4 rounded-xl shadow-md border border-green-200">
            <p class="text-sm text-green-600">Completed Enrollments</p>
            <h3 class="text-2xl font-bold text-green-900 mt-1">{{ stats.completed }}</h3>
        </div>

        <div class="bg-yellow-50 p-4 rounded-xl shadow-md border border-yellow-200">
            <p class="text-sm text-yellow-600">In Progress</p>
            <h3 class="text-2xl font-bold text-yellow-900 mt-1">{{ stats.in_progress }}</h3>
        </div>

        <div class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-200">
            <p class="text-sm text-blue-600">Average Completion Rate</p>
            <h3 class="text-2xl font-bold text-blue-900 mt-1">{{ stats.average_completion }}%</h3>
        </div>
    </div>
    
    {# ========================================================================= #}
    {# 2. Chart Breakdown #}
    {# ========================================================================= #}
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Completion Breakdown by Department</h3>
        <div class="w-full h-80 flex items-center justify-center">
            <canvas id="dept-completion-chart"></canvas>
        </div>
        
        {{ chart_data|json_script:"hr_chart_data" }}
    </div>


    {# ========================================================================= #}
    {# 3. Advanced Filter Form #}
    {# ========================================================================= #}
    <form method="GET" action="{% url 'hr_appraisal_dashboard' %}" class="bg-gray-100 p-4 rounded-lg shadow-inner mb-8 space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            
            {# --- Search Query --- #}
            <div>
                <label for="id_q" class="block text-sm font-medium text-gray-700">Student/Course Search</label>
                <input type="search" name="q" id="id_q" value="{{ search_query }}"
                       class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"
                       placeholder="Name, Email, or Course Title">
            </div>

            {# --- Status Filter --- #}
            <div>
                <label for="id_status" class="block text-sm font-medium text-gray-700">Completion Status</label>
                <select name="status" id="id_status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="">All Statuses</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                </select>
            </div>

            {# --- Department Filter (Student's Department) --- #}
            <div>
                <label for="id_department" class="block text-sm font-medium text-gray-700">Student's Department</label>
                <select name="department" id="id_department" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="">All Departments</option>
                    {% for dept in department_choices %}
                        <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>
            
            {# --- Instructor Filter --- #}
            <div>
                <label for="id_instructor" class="block text-sm font-medium text-gray-700">Course Instructor</label>
                <select name="instructor" id="id_instructor" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="">All Instructors</option>
                    {% for instructor in instructor_choices %}
                        <option value="{{ instructor.pk }}" {% if instructor_filter == instructor.pk %}selected{% endif %}>{{ instructor.get_full_name|default:instructor.email }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>

        <div class="flex justify-between items-center pt-2">
            <div>
                <a href="{% url 'hr_appraisal_dashboard' %}" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-200">Clear Filters</a>
            </div>
            <div class="flex space-x-3">
                 <a href="?export=csv&{{ request.GET.urlencode }}" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200">
                    <i class="fas fa-file-excel mr-2"></i> Export Data
                 </a>
                 <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-200">
                    <i class="fas fa-filter mr-2"></i> Apply Filters
                </button>
            </div>
        </div>
    </form>
    
    <!-- Results Table -->
    <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Title</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instructor</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Dept.</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Enrolled On</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Completed On</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for enrollment in page_obj %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ enrollment.student.get_full_name|default:enrollment.student.email }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ enrollment.course.title }}
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-600">
                        {{ enrollment.course.instructor.get_full_name|default:enrollment.course.instructor.email }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ enrollment.student.department|default:"N/A" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full 
                                {% if enrollment.completed %}bg-green-600{% else %}bg-indigo-600{% endif %}" 
                                style="width: {{ enrollment.progress_perc }}%;">
                            </div>
                        </div>
                        <span class="text-xs text-gray-500 mt-1 block">{{ enrollment.progress_perc|floatformat:0 }}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if enrollment.completed %}bg-green-100 text-green-800{% else %}bg-indigo-100 text-indigo-800{% endif %}">
                            {% if enrollment.completed %}Completed{% else %}In Progress{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">
                        {{ enrollment.enrolled_at|date:"M d, Y" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">
                        {% if enrollment.completed_at %}
                            {{ enrollment.completed_at|date:"M d, Y" }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-10 text-center text-lg text-gray-500">
                        No enrollment data found matching your filters.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
        <div class="mt-6 flex justify-center">
            {% include 'includes/pagination.html' with page_obj=page_obj page_param='page' %}
        </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
    // JSON data generated from Python view
    // Note: The template context must expose this data via a json_script tag
    
    const chartDataElement = document.getElementById('hr_chart_data');
    
    if (chartDataElement) {
        const chartData = chartDataElement.textContent;
        const data = JSON.parse(chartData);
    
        const labels = data.labels;
        const percentages = data.percentages; // Now contains the calculated percentage

        // Fix 2: Determine background colors dynamically based on percentage success threshold
        const colors = percentages.map(p => {
            if(p < 50) return 'rgba(239, 68, 68, 0.8)';      // Red (low progress)
            else if(p < 80) return 'rgba(251, 191, 36, 0.8)'; // Yellow (mid progress)
            else return 'rgba(16, 185, 129, 0.8)';            // Green (high/completed)
        });
    
        const ctx = document.getElementById('dept-completion-chart').getContext('2d');
    
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: percentages,
                    backgroundColor: colors, 
                    borderColor: 'rgba(5, 150, 105, 1)',
                    borderWidth: 1,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Completion Rate (%)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.raw.toFixed(1) + '%';
                                return label;
                            }
                        }
                    }
                }
            }
        });
    } else {
         console.warn("Chart data element 'hr_chart_data' not found. Chart display skipped.");
    }
</script>
{% endblock %}