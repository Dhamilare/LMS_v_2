{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Assign Course to Student{% endblock %}

{% block content %}
<div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-7xl mx-auto my-6 sm:my-8">
    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-user-plus mr-2 sm:mr-3 text-indigo-600"></i> Assign Courses
    </h2>

    <!-- Header and Assign Button -->
    <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
        <p class="text-gray-600 text-base sm:text-lg">View, search, and manage all student course assignments from one place.</p>
        <button id="assign-course-btn"
                class="w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center sm:justify-start shadow-md hover:shadow-lg">
            <i class="fas fa-plus-circle mr-2"></i> Assign New Course
        </button>
    </div>

    <!-- Search and Statistics Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Search Form -->
        <div class="col-span-1 md:col-span-2">
            <form method="GET" action="." class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                <div class="relative w-full">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="search" name="q" value="{{ search_query }}"
                           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-sm"
                           placeholder="Search by student or course title">
                </div>
                <button type="submit"
                        class="w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300">
                    Search
                </button>
            </form>
        </div>

        <!-- Stacked Bar Chart -->
        <div class="col-span-1 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Student Progress by Module</h3>
            <div class="w-full h-48 flex items-center justify-center">
                <canvas id="enrollment-chart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Enrollment Cards Grid (Responsive) -->
    <!-- The grid adjusts based on screen size: 1 column on mobile, 2 on medium screens, 3 on large screens -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for enrollment in page_obj %}
        <div class="bg-gray-50 rounded-lg shadow-md hover:shadow-lg transition duration-300 overflow-hidden">
            <div class="p-5">
                <div class="flex items-center space-x-3 mb-2">
                    <div class="flex-shrink-0 w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900">{{ enrollment.student.get_full_name|default:enrollment.student.username }}</h4>
                        <p class="text-sm text-gray-500">{{ enrollment.course.title }}</p>
                    </div>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="flex items-center text-sm text-gray-700">
                        <i class="fas fa-calendar-alt text-gray-400 mr-2"></i>
                        <span>Assigned: {{ enrollment.enrolled_at|date:"F d, Y" }}</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-700">
                        {% if enrollment.completed %}
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>Completed: {{ enrollment.completed_at|date:"F d, Y" }}</span>
                        {% else %}
                            <i class="fas fa-spinner fa-spin text-yellow-500 mr-2"></i>
                            <span>Status: In Progress</span>
                        {% endif %}
                    </div>
                    <div class="mt-4">
                        <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-200">
                            Progress: {{ enrollment.progress_percentage }}%
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-10">
            <p class="text-gray-500 text-lg">No assignments found matching your criteria.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav class="mt-8 flex flex-wrap justify-center items-center space-x-2 space-y-2 sm:space-y-0">
        {% if page_obj.has_previous %}
            <a href="?page=1&q={{ search_query }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                &laquo; First
            </a>
            <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                &lsaquo; Previous
            </a>
        {% endif %}

        <span class="text-sm text-gray-700 mx-2">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Next &rsaquo;
            </a>
            <a href="?page={{ page_obj.paginator.num_pages }}&q={{ search_query }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Last &raquo;
            </a>
        {% endif %}
    </nav>
    {% endif %}

    <div class="mt-8 text-center">
        <a href="{% url 'dashboard' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- MODAL HTML STRUCTURES -->

<!-- Modal for the Assign Course Form -->
<div id="assign-modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
        <div class="flex items-center justify-between p-4 border-b">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-800"></h3>
            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div id="modal-body" class="p-6">
            <!-- AJAX form content will be loaded here -->
        </div>
    </div>
</div>

<!-- Modal for alerts and messages (REPLACES alert()) -->
<div id="message-modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-4">
        <div class="p-6 text-center">
            <div id="message-icon" class="mb-4 text-4xl"></div>
            <h3 id="message-title" class="text-2xl font-bold mb-2"></h3>
            <p id="message-body" class="text-gray-600 mb-6"></p>
            <button id="close-message-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300">OK</button>
        </div>
    </div>
</div>

<!-- This is the corrected way to pass JSON data from Django to JavaScript -->
{{ chart_data|json_script:"chart_data" }}

{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // --- Chart.js Initialization ---
    window.addEventListener('DOMContentLoaded', function () {
        // Correctly parse JSON from the script tag
        const chartData = JSON.parse(document.getElementById('chart_data').textContent);

        const ctx = document.getElementById('enrollment-chart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: chartData.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Ensures the chart fills its container
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: false,
                        text: 'Student Progress by Module'
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // --- Modal Logic for Forms and Messages ---
        const assignModal = document.getElementById('assign-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const assignButton = document.getElementById('assign-course-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const assignCourseUrl = "{% url 'assign_course' %}";

        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageBody = document.getElementById('message-body');
        const messageIcon = document.getElementById('message-icon');
        const closeMessageBtn = document.getElementById('close-message-btn');

        // Function to show a general message modal
        function showMessageModal(title, message, isSuccess = true) {
            messageTitle.textContent = title;
            messageBody.textContent = message;
            messageIcon.innerHTML = isSuccess
                ? '<i class="fas fa-check-circle text-green-500"></i>'
                : '<i class="fas fa-exclamation-triangle text-red-500"></i>';

            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        // Function to close the general message modal
        function closeMessageModal() {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
        }

        // Function to close the assign form modal
        function closeAssignModal() {
            assignModal.classList.add('hidden');
            assignModal.classList.remove('flex');
            modalBody.innerHTML = '';
        }

        function loadAssignForm(url, title) {
            modalTitle.textContent = title;
            modalBody.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-indigo-600 fa-2x"></i></div>';
            
            fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.text();
            })
            .then(html => {
                modalBody.innerHTML = html;
                assignModal.classList.remove('hidden');
                assignModal.classList.add('flex');
                attachFormSubmissionHandler();
            })
            .catch(error => {
                console.error('Error fetching form:', error);
                showMessageModal('Error', 'Failed to load the form. Please try again.', false);
                closeAssignModal();
            });
        }

        function attachFormSubmissionHandler() {
            const form = document.querySelector('#assign-modal form');
            if (form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const formData = new FormData(form);
                    const submitButton = form.querySelector('button[type="submit"]');
                    const originalHtml = submitButton.innerHTML;

                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            closeAssignModal();
                            showMessageModal('Success!', data.message);
                            // Reload the page after a successful submission
                            setTimeout(() => { window.location.reload(); }, 1500); 
                        } else {
                            // If form validation fails, the server sends back the form HTML with errors
                            if (data.form_html) {
                                modalBody.innerHTML = data.form_html;
                                attachFormSubmissionHandler(); // Re-attach handler to the new form
                            }
                            showMessageModal('Error', data.message, false);
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalHtml;
                        }
                    })
                    .catch(error => {
                        console.error('Error during form submission:', error);
                        closeAssignModal();
                        showMessageModal('Error', 'An error occurred. Please try again.', false);
                    });
                });
            }
        }

        if (assignButton) {
            assignButton.addEventListener('click', () => {
                loadAssignForm(assignCourseUrl, 'Assign a Course to a Student');
            });
        }

        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeAssignModal);
        }

        if (assignModal) {
            assignModal.addEventListener('click', function(e) {
                if (e.target.id === 'assign-modal') {
                    closeAssignModal();
                }
            });
        }

        if (closeMessageBtn) {
            closeMessageBtn.addEventListener('click', closeMessageModal);
        }
    });
</script>
{% endblock %}
