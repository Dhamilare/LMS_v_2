{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Manage Quizzes{% endblock %}

{% block content %}
<div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-7xl mx-auto my-8">
    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-clipboard-question mr-2 sm:mr-3 text-indigo-600"></i> Manage Your Quizzes
    </h2>

    <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
        <p class="text-gray-600 text-base sm:text-lg">Here you can create, edit, and assign quizzes to your courses.</p>
        <button onclick="loadModalForm('{% url 'quiz_create' %}', 'Create New Quiz')"
                class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center shadow-md hover:shadow-lg">
            <i class="fas fa-plus-circle mr-2"></i> Create New Quiz
        </button>
    </div>

    {% if quizzes %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {% for quiz in quizzes %}
                <div class="bg-gray-50 rounded-lg shadow-md border border-gray-200 p-5 transform hover:scale-105 transition duration-300 ease-in-out">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">{{ quiz.title }}</h3>
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ quiz.description|default:"No description provided." }}</p>
                    <div class="text-gray-500 text-xs mb-3">
                        <p><i class="fas fa-percent mr-1"></i> Pass Percentage: {{ quiz.pass_percentage }}%</p>
                        <p><i class="fas fa-redo-alt mr-1"></i> Max Attempts: {{ quiz.max_attempts }}</p>
                    </div>

                    {% if quiz.course %}
                        <p class="text-sm text-green-700 flex items-center mb-3">
                            <i class="fas fa-link mr-2"></i> Assigned to Course: {{ quiz.course.title }}
                        </p>
                    {% else %}
                        <p class="text-sm text-yellow-700 flex items-center mb-3">
                            <i class="fas fa-unlink mr-2"></i> Not yet assigned to a course.
                        </p>
                    {% endif %}

                    <div class="flex flex-wrap gap-2 mt-4">
                        <a href="{% url 'quiz_detail_manage' quiz_id=quiz.id %}"
                           class="bg-blue-600 text-white py-2 px-3 rounded-md hover:bg-blue-700 transition duration-300 flex items-center text-sm shadow-sm">
                            <i class="fas fa-cogs mr-2"></i> Manage Questions
                        </a>
                        <button onclick="loadModalForm('{% url 'quiz_assign_to_course' quiz_id=quiz.id %}', 'Assign Quiz: {{ quiz.title }}')"
                                class="bg-purple-600 text-white py-2 px-3 rounded-md hover:bg-purple-700 transition duration-300 flex items-center text-sm shadow-sm">
                            <i class="fas fa-link mr-2"></i> Assign To Course
                        </button>
                        <button onclick="loadModalForm('{% url 'quiz_edit' quiz_id=quiz.id %}', 'Edit Quiz: {{ quiz.title }}')"
                                class="bg-gray-600 text-white py-2 px-3 rounded-md hover:bg-gray-700 transition duration-300 flex items-center text-sm shadow-sm">
                            <i class="fas fa-edit mr-2"></i> Edit Quiz Details
                        </button>
                        <button onclick="confirmDelete('{% url 'quiz_delete' quiz_id=quiz.id %}', '{{ quiz.title }}')"
                                class="bg-red-600 text-white py-2 px-3 rounded-md hover:bg-red-700 transition duration-300 flex items-center text-sm shadow-sm">
                            <i class="fas fa-trash-alt mr-2"></i> Delete
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-8 sm:py-10 bg-gray-50 rounded-lg shadow-sm border border-gray-200 mt-8">
            <p class="text-gray-600 text-base sm:text-lg mb-4 flex items-center justify-center">
                <i class="fas fa-info-circle mr-2"></i> You haven't created any quizzes yet.
            </p>
            <button onclick="loadModalForm('{% url 'quiz_create' %}', 'Create New Quiz')"
                    class="bg-indigo-600 text-white py-2 px-5 sm:px-6 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center mx-auto w-fit shadow-md hover:shadow-lg text-sm sm:text-base">
                <i class="fas fa-plus-circle mr-2"></i> Create Your First Quiz
            </button>
        </div>
    {% endif %}

    <div class="mt-8 text-center">
        <a href="{% url 'dashboard' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

{% include 'partials/modal_base.html' %}
{% include 'partials/confirmation_modal.html' %}

<!-- Custom Delete Confirmation Modal -->
<div id="delete-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-gray-900 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-800">Confirm Deletion</h3>
            <button onclick="hideModal('delete-modal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div class="mb-6">
            <p class="text-gray-700" id="delete-message"></p>
        </div>
        <div class="flex justify-end space-x-4">
            <button onclick="hideModal('delete-modal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition duration-300">
                Cancel
            </button>
            <button id="confirm-delete-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-300">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Custom Toast Notification Container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-[60] flex flex-col items-end space-y-2"></div>
{% endblock %}


{% block extra_scripts %}
{{ block.super }}
{% csrf_token %}
<script>
    // Wait for the entire document to be ready before running the script
    document.addEventListener('DOMContentLoaded', function() {
        // ================================
        // Toast Notification System
        // ================================
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            let bgColor, icon;

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = '<i class="fas fa-check-circle mr-2"></i>';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
                    break;
                default:
                    bgColor = 'bg-gray-700';
                    icon = '<i class="fas fa-info-circle mr-2"></i>';
            }

            toast.className = `flex items-center px-4 py-3 rounded-lg text-white shadow-md transform transition-transform duration-300 ease-out translate-x-full ${bgColor}`;
            toast.innerHTML = `${icon}<span>${message}</span>`;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                });
            }, 5000);
        }

        // ================================
        // Modal Elements
        // ================================
        const mainModal = document.getElementById('quiz-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        const deleteModal = document.getElementById('delete-modal');
        const deleteMessage = document.getElementById('delete-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-button');

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // ================================
        // Utility Functions
        // ================================
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        window.hideModal = hideModal;
        window.showModal = showModal;

        // ================================
        // Main Quiz Modal Functions
        // ================================
        function closeMainModal() {
            if (mainModal) {
                hideModal('quiz-modal');
                modalBody.innerHTML = '';
            }
        }

        function loadModalForm(url, title) {
            if (modalTitle) modalTitle.textContent = title;
            if (modalBody) modalBody.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-indigo-600 fa-2x"></i></div>';

            fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.text();
            })
            .then(html => {
                if (modalBody) modalBody.innerHTML = html;
                showModal('quiz-modal');
                attachFormSubmissionHandler();
            })
            .catch(error => {
                console.error('Error fetching form:', error);
                if (modalBody) modalBody.innerHTML = '<p class="text-red-500">Failed to load the form. Please try again.</p>';
            });
        }

        function attachFormSubmissionHandler() {
            const form = document.querySelector('#quiz-modal form');
            if (form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();

                    const formData = new FormData(form);
                    const submitButton = form.querySelector('button[type="submit"]');

                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
                    }

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showToast(data.message, 'success');
                            window.location.reload();
                        } else {
                            if (modalBody) modalBody.innerHTML = data.form_html;
                            attachFormSubmissionHandler();
                        }
                    })
                    .catch(error => {
                        console.error('Error during form submission:', error);
                        showToast('An error occurred. Please try again.', 'error');
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Save Quiz';
                        }
                    });
                });
            }
        }

        if (mainModal) {
            mainModal.addEventListener('click', function(e) {
                if (e.target.id === 'quiz-modal') {
                    closeMainModal();
                }
            });
        }

        // ================================
        // Delete Confirmation Modal
        // ================================
        window.confirmDelete = (url, quizTitle) => {
            console.log("Confirming delete for:", quizTitle);
            if (deleteMessage) {
                deleteMessage.textContent = `Are you sure you want to delete the quiz "${quizTitle}"? This action cannot be undone.`;
            }
            showModal('delete-modal');

            confirmDeleteBtn.onclick = (e) => {
                e.stopPropagation();
                console.log("Attempting to delete quiz. URL:", url);

                const csrftokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrftokenElement) {
                    console.error("CRITICAL: CSRF token element not found! Cannot proceed with deletion.");
                    showToast("CSRF token not found. Cannot delete.", 'error');
                    hideModal('delete-modal');
                    return;
                }
                const csrftoken = csrftokenElement.value;
                console.log("CSRF token found:", csrftoken);

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    console.log("Fetch response received. Status:", response.status);
                    if (!response.ok) {
                        if (response.status === 403) {
                            console.error("Permission or CSRF error (403). Possible issues: incorrect CSRF token, or user is not the quiz owner.");
                            throw new Error("You don't have permission to delete this quiz, or the CSRF token is invalid.");
                        }
                        return response.text().then(text => { throw new Error(text) });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        window.location.reload();
                    } else {
                        console.error("Deletion failed:", data.message);
                        showToast(data.message, 'error');
                        hideModal('delete-modal');
                    }
                })
                .catch(error => {
                    console.error('Error during deletion:', error);
                    showToast(`An error occurred: ${error.message}`, 'error');
                    hideModal('delete-modal');
                });
            };
        };

        if (deleteModal) {
            deleteModal.addEventListener('click', function(e) {
                if (e.target.id === 'delete-modal') {
                    hideModal('delete-modal');
                }
            });
        }
    }); // End of DOMContentLoaded
</script>
{% endblock %}
