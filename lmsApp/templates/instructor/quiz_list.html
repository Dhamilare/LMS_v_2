{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Manage Quizzes{% endblock %}

{% block content %}
<div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-7xl mx-auto my-8">
    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-clipboard-question mr-2 sm:mr-3 text-indigo-600"></i> Manage Your Quizzes
    </h2>

    <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
        <p class="text-gray-600 text-base sm:text-lg">Here you can create, edit, and assign quizzes to your courses.</p>
        <button onclick="loadModalForm('{% url 'quiz_create' %}', 'Create New Quiz')"
                class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center shadow-md hover:shadow-lg">
            <i class="fas fa-plus-circle mr-2"></i> Create New Quiz
        </button>
    </div>

    {% if quizzes %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {% for quiz in quizzes %}
                <div class="bg-gray-50 rounded-lg shadow-md border border-gray-200 p-5 transform hover:scale-105 transition duration-300 ease-in-out">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">{{ quiz.title }}</h3>
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ quiz.description|default:"No description provided." }}</p>
                    <div class="text-gray-500 text-xs mb-3">
                        <p><i class="fas fa-percent mr-1"></i> Pass Percentage: {{ quiz.pass_percentage }}%</p>
                        <p><i class="fas fa-redo-alt mr-1"></i> Max Attempts: {{ quiz.max_attempts }}</p>
                        <!-- <p><i class="fas fa-clock mr-1"></i> Duration: {{ quiz.duration_minutes }} mins (Informational)</p> -->
                    </div>
                    
                    {% if quiz.course %}
                        <p class="text-sm text-green-700 flex items-center mb-3">
                            <i class="fas fa-link mr-2"></i> Assigned to Course: {{ quiz.course.title }}
                        </p>
                    {% else %}
                        <p class="text-sm text-yellow-700 flex items-center mb-3">
                            <i class="fas fa-unlink mr-2"></i> Not yet assigned to a course.
                        </p>
                    {% endif %}

                    <div class="flex flex-wrap gap-2 mt-4">
                        <a href="{% url 'quiz_detail_manage' quiz_id=quiz.id %}"
                           class="bg-blue-600 text-white py-2 px-3 rounded-md hover:bg-blue-700 transition duration-300 flex items-center text-sm shadow-sm">
                            <i class="fas fa-cogs mr-2"></i> Manage Questions
                        </a>
                        <button onclick="loadModalForm('{% url 'quiz_assign_to_course' quiz_id=quiz.id %}', 'Assign Quiz: {{ quiz.title }}')"
                                class="bg-purple-600 text-white py-2 px-3 rounded-md hover:bg-purple-700 transition duration-300 flex items-center text-sm shadow-sm">
                            <i class="fas fa-link mr-2"></i> Assign To Course
                        </button>
                        <button onclick="loadModalForm('{% url 'quiz_create' %}?quiz_id={{ quiz.id }}', 'Edit Quiz: {{ quiz.title }}')"
                                class="bg-gray-600 text-white py-2 px-3 rounded-md hover:bg-gray-700 transition duration-300 flex items-center text-sm shadow-sm">
                            <i class="fas fa-edit mr-2"></i> Edit Quiz Details
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-8 sm:py-10 bg-gray-50 rounded-lg shadow-sm border border-gray-200 mt-8">
            <p class="text-gray-600 text-base sm:text-lg mb-4 flex items-center justify-center">
                <i class="fas fa-info-circle mr-2"></i> You haven't created any quizzes yet.
            </p>
            <button onclick="loadModalForm('{% url 'quiz_create' %}', 'Create New Quiz')"
                    class="bg-indigo-600 text-white py-2 px-5 sm:px-6 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center mx-auto w-fit shadow-md hover:shadow-lg text-sm sm:text-base">
                <i class="fas fa-plus-circle mr-2"></i> Create Your First Quiz
            </button>
        </div>
    {% endif %}

    <div class="mt-8 text-center">
        <a href="{% url 'dashboard' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

{% include 'partials/modal_base.html' %}
{% include 'partials/confirmation_modal.html' %}

{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
    // Get modal elements
    const modal = document.getElementById('quiz-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');

    // Function to close the main modal
    function closeModal() {
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modalBody.innerHTML = ''; // Clear content on close
        }
    }

    // Function to load a form into the main modal via AJAX
    function loadModalForm(url, title) {
        if (modalTitle) modalTitle.textContent = title;
        if (modalBody) modalBody.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-indigo-600 fa-2x"></i></div>';
        
        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text) });
            }
            return response.text();
        })
        .then(html => {
            if (modalBody) modalBody.innerHTML = html;
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            attachFormSubmissionHandler();
        })
        .catch(error => {
            console.error('Error fetching form:', error);
            if (modalBody) modalBody.innerHTML = '<p class="text-red-500">Failed to load the form. Please try again.</p>';
        });
    }

    // Function to handle the AJAX form submission
    function attachFormSubmissionHandler() {
        const form = document.querySelector('#quiz-modal form');
        if (form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type="submit"]');

                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
                }

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text) });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Success: The quiz was created.
                        alert(data.message);
                        
                        // THIS IS THE KEY CHANGE:
                        // Instead of redirecting, we simply reload the page.
                        // This forces the Django view to re-render the page
                        // with the new quiz data.
                        window.location.reload();

                    } else {
                        // Failure: Validation errors. Update the modal with the new form HTML.
                        if (modalBody) modalBody.innerHTML = data.form_html;
                        attachFormSubmissionHandler();
                    }
                })
                .catch(error => {
                    console.error('Error during form submission:', error);
                    alert('An error occurred. Please try again.');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-save mr-2"></i> Save Quiz';
                    }
                });
            });
        }
    }

    // Event listener to close the modal when clicking outside
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target.id === 'quiz-modal') {
                closeModal();
            }
        });
    }
</script>
{% endblock %}
